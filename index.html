const ipCache = new Map();

export default async function handler(req, res) {
  const clientIp = req.headers['x-forwarded-for'] || req.socket.remoteAddress;
  const userData = ipCache.get(clientIp) || { count: 0 };

  if (userData.count >= 10) return res.status(429).json({ error: "Günlük limit doldu!" });

  const { prompt, mode } = req.body;
  const securePrompt = `${prompt} [KURAL: KESİNLİKLE MAX 100 KARAKTER VE SADECE ${mode} YAZ]`;

  const r = await fetch("https://generativelanguage.googleapis.com/v1/models/gemini-2.0-flash:generateContent?key=" + process.env.GEMINI_API_KEY, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ contents: [{ parts: [{ text: securePrompt }] }], generationConfig: { maxOutputTokens: 40 } }),
  });

  const data = await r.json();
  const reply = data?.candidates?.[0]?.content?.parts?.[0]?.text || "Cevap gelmedi.";
  
  ipCache.set(clientIp, { count: userData.count + 1 });
  res.status(200).json({ reply: reply.substring(0, 100) });
}
